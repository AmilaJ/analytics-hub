<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Analytics>
    <Name>Sparkscript-hubAnalytics-TrafficReport</Name>
    <Script>
    
	create temporary table org_wso2telco_analytics_hub_stream_payment_processedstatistics_ratecard using CarbonAnalytics options (tableName "ORG_WSO2TELCO_ANALYTICS_HUB_STREAM_PAYMENT_PROCESSEDSTATISTICS", schema "api STRING -i,responseTime LONG -i,serviceTime LONG -i,serviceProvider STRING -i,apiPublisher STRING -i,applicationName STRING -i,operatorId     STRING -i,responseCode STRING -i,msisdn STRING -i,direction STRING -i,eventType STRING -i,totalAmountChargedOrRefunded DOUBLE -i,onBehalfOf STRING -i,purchaseCategoryCode STRING -i,taxAmount DOUBLE -i,channel STRING -i,amount DOUBLE -i,currency STRING -i,description STRING -i,serverReferenceCode STRING -i,clientCorrelator STRING -i,transactionOperationStatus STRING -i,referenceCode STRING -i,endUserId STRING -i,resourceURL STRING -i,year INTEGER -i,month INTEGER -i,day INTEGER -i,hour INTEGER -i,operatorName STRING -i,apiPublisherID STRING -i,apiID STRING -i,department STRING -i,applicationId STRING -i,eventTimeStamp LONG -i,_timestamp LONG -i");
	create temporary table org_wso2telco_analytics_hub_stream_summery_ratecard using CarbonAnalytics options (tableName "ORG_WSO2TELCO_ANALYTICS_HUB_STREAM_SP_TRAFFIC_BILL_SUMMARY_PER_DAY", schema "api STRING -i,applicationName STRING -i,operatorId STRING -i,direction STRING -i,eventType STRING -i,operatorName STRING -i,operatorId     STRING -i,purchaseCategoryCode STRING -i,sum_totalAmount STRING -i,direction STRING -i,spcommission STRING -i,revShare_sp STRING -i,eventTimeStamp LONG -i,_timestamp LONG -i");


	INSERT OVERWRITE TABLE org_wso2telco_analytics_hub_stream_summery_ratecard
	select api,applicationName,operatorId,direction,eventType, operatorName, purchaseCategoryCode, sum_totalAmount,spcommission, (sum_totalAmount*(spcommission/100)) as revShare_sp,timestamp,timestamp
	from(
		select api,applicationName,operatorId,direction,eventType, operatorName, purchaseCategoryCode, sum(amount) as sum_totalAmount, getNBCommissionSP(api,eventType,'5',purchaseCategoryCode) as spcommission,getDateTimestamp(first(responseTime)) as timestamp
		from org_wso2telco_analytics_hub_stream_payment_processedstatistics_ratecard
		where direction ='north-bound'
		group by api,applicationName,operatorId,direction,eventType, operatorName, purchaseCategoryCode, getDateTimestamp(responseTime)
	) as outerTable

       
</Script>
    <CronExpression>0 0/20 * * * ?</CronExpression>
</Analytics>
  










 

                                                                               
                            
                            
